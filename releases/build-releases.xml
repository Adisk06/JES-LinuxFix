<?xml version="1.0" encoding="UTF-8" ?>

<!--
    This file isn't complete on its own!
    It needs to be imported from JES's main build.xml.
-->

    <!-- Release file structures -->
    <property name="jes.release.stage"      location="${jes.release.dir}/stage" />
    <property name="jes.release.resources"  location="${jes.release.dir}/resources" />
    <property name="jes.release.basename"   value="jes-${jes.release}" />


    <!-- Master "release" target -->
    <target name="release" depends="release-linux, release-windows-all, release-macosx"
        description="Build all the releases we can make on the current platform." />

    <target name="clean-releases"
        description="Remove built releases, and the staging directories.">
        <delete includeemptydirs="true">
            <fileset dir="${jes.release.dir}">
                <include name="**/*" />
                <exclude name="build-releases.xml" />
                <exclude name="resources/**/*" />
            </fileset>
        </delete>
    </target>

    <target name="clean-release-stage"
        description="Remove the staging directories for releases, but leave the release packages.">
        <delete dir="${jes.release.stage}" />
    </target>


    <!-- File lists common across releases -->
    <fileset id="jes.release.contents.python" dir="${basedir}">
        <include name="jes/python/**/*.py" />
        <include name="dependencies/jython/**/*" />
    </fileset>

    <fileset id="jes.release.contents.java-src" dir="${basedir}">
        <include name="jes/java/**/*.java" />
    </fileset>

    <fileset id="jes.release.contents.java-built" dir="${basedir}">
        <include name="jes/classes/**/*.class" />
        <include name="dependencies/jars/**/*.jar" />
    </fileset>

    <fileset id="jes.release.contents.static" dir="${basedir}">
        <include name="jes/images/**/*" />
        <include name="jes/help/**/*" />
        <include name="jes/javadoc/**/*" />
    </fileset>

    <fileset id="jes.release.extras" dir="${basedir}">
        <include name="demos/**/*.py" />
    </fileset>


    <!-- Common readme fragments -->
    <loadfile property="jes.release.text.introduction"
        srcFile="${jes.release.resources}/introduction.txt" />
    <filter token="introductiontext"            value="${jes.release.text.introduction}" />


    <!-- linux release type: shell script, no embedded Java -->
    <property name="jes.release.linux.resources"    location="${jes.release.resources}/linux" />
    <property name="jes.release.linux.readme"       location="${jes.release.linux.resources}/JESReadme.txt" />

    <property name="jes.release.linux.basename"     value="${jes.release.basename}-linux" />
    <property name="jes.release.linux.stage"
            location="${jes.release.stage}/${jes.release.linux.basename}" />
    <property name="jes.release.linux.tarball"
            location="${jes.release.dir}/${jes.release.linux.basename}.tar.gz" />

    <target name="release-linux" depends="build"
        description="Build a release for Linux and other UNIX systems">
        <!-- Create and clean the stage directory -->
        <mkdir dir="${jes.release.linux.stage}" />
        <delete includeemptydirs="true">
            <fileset dir="${jes.release.linux.stage}" includes="**/*" />
        </delete>

        <!-- Copy everything JES needs into the stage directory -->
        <copy todir="${jes.release.linux.stage}">
            <fileset refid="jes.release.contents.python" />
            <fileset refid="jes.release.contents.java-built" />
            <fileset refid="jes.release.contents.java-src" />
            <fileset refid="jes.release.contents.static" />
            <fileset refid="jes.release.extras" />
        </copy>

        <copy file="${jes.launcher.sh}" todir="${jes.release.linux.stage}" />
        <chmod file="${jes.release.linux.stage}/jes.sh" perm="755" />

        <copy file="${jes.help.copyright}" todir="${jes.release.linux.stage}" />
        <copy file="${jes.release.linux.readme}" todir="${jes.release.linux.stage}" filtering="on" />

        <!-- Tar it all up -->
        <tar destfile="${jes.release.linux.tarball}" longfile="gnu">
            <tarfileset dir="${jes.release.stage}"
                includes="${jes.release.linux.basename}/**/*"
                excludes="${jes.release.linux.basename}/jes.sh" />
            <tarfileset dir="${jes.release.stage}" filemode="755"
                includes="${jes.release.linux.basename}/jes.sh" />
        </tar>
    </target>


    <!-- Common code across Windows release types -->
    <property name="jes.release.windows.resources"  location="${jes.release.resources}/windows" />
    <property name="jes.release.windows.exe"        location="${jes.release.windows.resources}/JES.exe" />

    <property name="jes.release.windows.basename"   value="${jes.release.basename}-windows" />
    <property name="jes.release.windows.stage"
            location="${jes.release.stage}/${jes.release.windows.basename}-contents" />
    <property name="jes.release.windows.stage.readmes"
            location="${jes.release.windows.stage}/readmes" />

    <property name="jes.release.windows.jre.basename" value="jre-win32-1.7.0_60" />
    <property name="jes.release.windows.jre.zipfile"
            location="${jes.release.windows.resources}/${jes.release.windows.jre.basename}.zip" />

    <target name="release-windows-all"
        depends="release-windows-zip-nojava, release-windows-zip-java, release-windows-installer"
        description="Builds all available Windows release types" />

    <target name="release-windows-contents" depends="build"
        description="Builds the release contents for Windows, but not an actual release">
        <!-- Create and clean the stage directory -->
        <mkdir dir="${jes.release.windows.stage}" />
        <delete includeemptydirs="true">
            <fileset dir="${jes.release.windows.stage}" includes="**/*" />
        </delete>

        <!-- Copy everything JES needs into the stage directory -->
        <copy todir="${jes.release.windows.stage}">
            <fileset refid="jes.release.contents.python" />
            <fileset refid="jes.release.contents.java-built" />
            <fileset refid="jes.release.contents.java-src" />
            <fileset refid="jes.release.contents.static" />
            <fileset refid="jes.release.extras" />
        </copy>

        <copy file="${jes.launcher.bat}" todir="${jes.release.windows.stage}" />
        <copy file="${jes.release.windows.exe}" todir="${jes.release.windows.stage}" />
        <copy file="${jes.help.copyright}" todir="${jes.release.windows.stage}" />
    </target>

    <fileset id="jes.release.windows.stage.contents" dir="${jes.release.windows.stage}">
        <exclude name="readmes/" />
        <exclude name="*.nsi" />
        <exclude name="${jes.release.windows.basename}-*.exe" />
    </fileset>


    <!-- windows-zip release type: exe + batch file in a ZIP, no embedded Java -->
    <property name="jes.release.windows.zip-nojava.zipfile"
            location="${jes.release.dir}/${jes.release.windows.basename}-java-required.zip" />
    <property name="jes.release.windows.zip-java.zipfile"
            location="${jes.release.dir}/${jes.release.windows.basename}-java-included.zip" />

    <target name="release-windows-zip-nojava" depends="release-windows-contents"
        description="Builds a ZIP file for Windows (with no JRE)">
        <!-- Reset the ZIP -->
        <delete file="${jes.release.windows.zip-nojava.zipfile}" />
        <!-- Build our readme...we're doing this slightly weirdly -->
        <mkdir dir="${jes.release.windows.stage.readmes}/zip-nojava" />
        <copy file="${jes.release.windows.resources}/zip-nojava-readme.txt"
                tofile="${jes.release.windows.stage.readmes}/zip-nojava/JESReadme.txt"
                filtering="on" />

        <!-- ZIP it all up -->
        <zip destfile="${jes.release.windows.zip-nojava.zipfile}">
            <fileset refid="jes.release.windows.stage.contents" />
            <fileset dir="${jes.release.windows.stage.readmes}/zip-nojava" />
        </zip>
    </target>

    <target name="release-windows-zip-java" depends="release-windows-contents"
        description="Builds a ZIP file for Windows (including a JRE)">
        <!-- Reset the ZIP -->
        <delete file="${jes.release.windows.zip-java.zipfile}" />
        <!-- Build our readme...we're doing this slightly weirdly -->
        <mkdir dir="${jes.release.windows.stage.readmes}/zip-java" />
        <copy file="${jes.release.windows.resources}/zip-java-readme.txt"
                tofile="${jes.release.windows.stage.readmes}/zip-java/JESReadme.txt"
                filtering="on" />
        <copy file="${jes.release.windows.resources}/jre-win32-readme.txt"
                tofile="${jes.release.windows.stage.readmes}/zip-java/JavaReadme.txt"
                filtering="on" />

        <!-- ZIP it all up -->
        <zip destfile="${jes.release.windows.zip-java.zipfile}">
            <fileset refid="jes.release.windows.stage.contents" />
            <fileset dir="${jes.release.windows.stage.readmes}/zip-java" />
            <zipfileset src="${jes.release.windows.jre.zipfile}"
                    includes="**/*"
                    prefix="${jes.launcher.bat.embedded-jre}" />
        </zip>
    </target>


    <!-- windows-installer release type: exe + batch file, packed with NSIS, no embedded Java -->
    <property name="jes.release.windows.installer.filename"
            value="${jes.release.windows.basename}.exe" />

    <property name="jes.release.windows.installer.stage"
            location="${jes.release.windows.stage}/${jes.release.windows.installer.filename}" />
    <property name="jes.release.windows.installer.exe"
            location="${jes.release.dir}/${jes.release.windows.installer.filename}" />

    <target name="release-windows-installer" depends="release-windows-contents" if="makensis"
        description="Builds an EXE installer for Windows">
        <!-- Reset the installer -->
        <delete file="${jes.release.windows.installer.stage}" />

        <!-- Copy the .nsi file -->
        <copy file="${jes.release.windows.resources}/jes-installer.nsi"
                todir="${jes.release.windows.stage}" filtering="on" />

        <!-- Run makensis -->
        <exec executable="${makensis}" dir="${jes.release.windows.stage}">
            <arg value="jes-installer.nsi" />
        </exec>

        <!-- Move it to the releases directory -->
        <move file="${jes.release.windows.installer.stage}" todir="${jes.release.dir}" />
    </target>


    <!-- Mac OS X release -->
    <property name="jes.release.macosx.resources"  location="${jes.release.resources}/macosx" />

    <property name="jes.release.macosx.basename" value="${jes.release.basename}-macosx" />
    <property name="jes.release.macosx.bundle" location="${jes.release.dir}/JES.app" />
    <property name="jes.release.macosx.bundle.contents"
            location="${jes.release.macosx.bundle}/Contents/Resources/Java" />
    <property name="jes.release.macosx.zipfile"
            location="${jes.release.dir}/${jes.release.macosx.basename}.zip" />

    <!-- macosx-app release type: app packed with AppBundler -->
    <taskdef name="jarbundler"
             classname="net.sourceforge.jarbundler.JarBundler"
             classpath="${jes.release.macosx.resources}/jarbundler-2.3.1.jar" />

    <target name="release-macosx" depends="build">
        <!-- Pack the JES classes into a JAR -->
        <jar destfile="${jes.home}/classes.jar" basedir="${jes.java.class}" />

        <!-- Build the JES.app skeleton -->
        <delete dir="${jes.release.macosx.bundle}" />
        <delete file="${jes.release.macosx.zipfile}" />

        <jarbundler dir="${jes.release.dir}"
            mainclass="JESstartup"
            name="JES"
            bundleid="edu.gatech.cc.csl.JES"
            version="${jes.release}"
            copyright="${jes.copyright}"
            icon="${jes.home}/images/JESi2.icns"
            signature="JESX"
            stubfile="${jes.release.macosx.resources}/jes-launcher.sh"
            jvmversion="${jes.target-java}+"
            verbose="true">

            <jarfileset dir="${basedir}">
                <include name="jes/classes.jar" />
                <include name="dependencies/jars/*.jar" />
            </jarfileset>
        </jarbundler>

        <!-- Copy in the extra stuff -->
        <copy todir="${jes.release.macosx.bundle.contents}">
            <fileset refid="jes.release.contents.python" />
            <fileset refid="jes.release.contents.java-src" />
            <fileset refid="jes.release.contents.static" />
        </copy>

        <!-- Zip it all up -->
        <zip destfile="${jes.release.macosx.zipfile}">
            <zipfileset dir="${jes.release.dir}">
                <include name="JES.app/**/*" />
                <exclude name="JES.app/Contents/MacOS/jes-launcher.sh" />
            </zipfileset>
            <zipfileset filemode="755" dir="${jes.release.dir}">
                <include name="JES.app/Contents/MacOS/jes-launcher.sh" />
            </zipfileset>
        </zip>

        <!-- Get rid of the JAR we made -->
        <delete file="${jes.home}/classes.jar" />
    </target>

